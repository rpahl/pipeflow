<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced: How pipelines can modify themselves at runtime • pipeflow</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced: How pipelines can modify themselves at runtime">
<meta name="description" content="Shows how you can setup pipelines to modify themselves at runtime, which, for example, allows for changing pipeline parameters based on intermediate results or even dynamically modify the pipeline's own structure during a pipeline run.
">
<meta property="og:description" content="Shows how you can setup pipelines to modify themselves at runtime, which, for example, allows for changing pipeline parameters based on intermediate results or even dynamically modify the pipeline's own structure during a pipeline run.
">
<meta property="og:image" content="https://github.com/rpahl/pipeflow/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pipeflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="home"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/v01-get-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/index.html">Overview</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Get started</h6></li>
    <li><a class="dropdown-item" href="../articles/v01-get-started.html">Get started with pipeflow</a></li>
    <li><a class="dropdown-item" href="../articles/v02-modify-pipeline.html">Modifying existing pipelines</a></li>
    <li><a class="dropdown-item" href="../articles/v03-combine-pipelines.html">Combining pipelines</a></li>
    <li><a class="dropdown-item" href="../articles/v04-collect-output.html">Collecting pipeline output</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/v05-split-and-combine.html">How to use pipelines with split data sets</a></li>
    <li><a class="dropdown-item" href="../articles/v06-self-modify-pipeline.html">How pipelines can modify themselves at runtime</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-my-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">My Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-my-packages">
<li><a class="external-link dropdown-item" href="https://rpahl.github.io/container/">container</a></li>
    <li><a class="external-link dropdown-item" href="https://rpahl.github.io/GroupSeq/">GroupSeq</a></li>
    <li><a class="external-link dropdown-item" href="https://rpahl.github.io/pipeflow/">pipeflow</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="https://github.com/rpahl/pipeflow/" aria-label="github"><span class="fa fab fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://stackoverflow.com/users/8120617/rpahl" aria-label="stackoverflow"><span class="fa fab fa-stack-overflow"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/rpahl.bsky.social" aria-label="bluesky"><span class="fa fab fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://rpahl.github.io/r-some-blog/" aria-label="blog"><span class="fa fas fa-blog"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced: How pipelines can modify themselves at runtime</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rpahl/pipeflow/blob/HEAD/vignettes/v06-self-modify-pipeline.Rmd"><code>vignettes/v06-self-modify-pipeline.Rmd</code></a></small>
      <div class="d-none name"><code>v06-self-modify-pipeline.Rmd</code></div>
    </div>

    
    
<p>While the <code>pipeflow</code> package mostly aims to be an easy and
intuitive framework, it does provide some very advanced features and
interfaces that allow for a very flexible manipulation of the pipeline
objects. In this vignette we will introduce some of these features using
simple examples in order to give you an idea of what is possible.</p>
<div class="section level3">
<h3 id="changing-pipeline-parameters-at-runtime">Changing pipeline parameters at runtime<a class="anchor" aria-label="anchor" href="#changing-pipeline-parameters-at-runtime"></a>
</h3>
<p>Let’s first define a pipeline, which fits a linear model, checks it’s
residuals for normality using the Shapiro-Wilk test, and plots the
residuals.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpahl.github.io/pipeflow/" class="external-link">pipeflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span><span class="st">"my-pipeline"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"fit"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">data</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span>, <span class="va">xVar</span> <span class="op">=</span> <span class="st">"x"</span>, <span class="va">yVar</span> <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">yVar</span>, <span class="st">"~"</span>, <span class="va">xVar</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"residual_shapiro_p_value"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">fit</span> <span class="op">=</span> <span class="op">~</span><span class="va">fit</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>            <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/shapiro.test.html" class="external-link">shapiro.test</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span>            <span class="va">p</span></span>
<span>        <span class="op">}</span>,</span>
<span>        keepOut <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"plot"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">fit</span> <span class="op">=</span> <span class="op">~</span><span class="va">fit</span>, <span class="va">pointColor</span> <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>                fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,</span>
<span>                residuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">fitted</span>, y <span class="op">=</span> <span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">21</span>, color <span class="op">=</span> <span class="va">pointColor</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        keepOut <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>So our pipeline looks like this</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span></span>
<span><span class="co">#                        step depends    out keepOut                    group  state</span></span>
<span><span class="co">#                      &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt;                   &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:                     data         [NULL]   FALSE                     data    New</span></span>
<span><span class="co"># 2:                      fit    data [NULL]   FALSE                      fit    New</span></span>
<span><span class="co"># 3: residual_shapiro_p_value     fit [NULL]    TRUE residual_shapiro_p_value    New</span></span>
<span><span class="co"># 4:                     plot     fit [NULL]    TRUE                     plot    New</span></span></code></pre></div>
<p>and we can run it like this</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xVar <span class="op">=</span> <span class="st">"Ozone"</span>, yVar <span class="op">=</span> <span class="st">"Temp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">collect_out</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:31.793] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:31.821] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:31.835] Step 2/4 fit</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:31.853] Step 3/4 residual_shapiro_p_value</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:31.856] Step 4/4 plot</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:31.873] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:31.874] Done.</span></span>
<span><span class="co"># $residual_shapiro_p_value</span></span>
<span><span class="co"># [1] 0.00022598</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $plot</span></span></code></pre></div>
<p><img src="v06-self-modify-pipeline_files/figure-html/unnamed-chunk-3-1.png" alt="residual-plot" width="700"></p>
<p>Now let’s imagine, we want to change the color of the points in the
plot depending on the Shapiro-Wilk test result. The obvious way to do
this would be to change the <code>plot</code> step by passing the test
result to the <code>plot</code> step function and change the color
there.</p>
<p>However, here we are interested in another way that would keep the
<code>plot</code> function unchanged. For example, we could run the
pipeline a second time as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">pip</span><span class="op">$</span><span class="fu">get_out</span><span class="op">(</span><span class="st">"residual_shapiro_p_value"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointColor <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">pip</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">collect_out</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.276] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.278] Step 1/4 data - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.279] Step 2/4 fit - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.280] Step 3/4 residual_shapiro_p_value - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.281] Step 4/4 plot</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.296] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.297] Done.</span></span>
<span><span class="co"># $residual_shapiro_p_value</span></span>
<span><span class="co"># [1] 0.00022598</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $plot</span></span></code></pre></div>
<p><img src="v06-self-modify-pipeline_files/figure-html/unnamed-chunk-4-1.png" alt="residual-plot" width="700"></p>
<p>As was mentioned in another vignette, this solution is not ideal, as
it requires to run additional code outside the pipeline framework. To
solve this issue, we therefore basically have to set the parameter from
within the pipeline during execution. That is, we have to make the
pipeline aware of itself, which can be done by passing the pipeline
object as a parameter.</p>
<p>Let’s update the <code>residual_shapiro_p_value</code> step in the
above example.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">replace_step</span><span class="op">(</span></span>
<span>    <span class="st">"residual_shapiro_p_value"</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span></span>
<span>        <span class="va">fit</span> <span class="op">=</span> <span class="op">~</span><span class="va">fit</span>,</span>
<span>        <span class="va">.self</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>        <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/shapiro.test.html" class="external-link">shapiro.test</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">p</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">.self</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointColor <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="va">p</span></span>
<span>    <span class="op">}</span>,</span>
<span>    keepOut <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we just have to make sure to set the <code>.self</code>
parameter.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xVar <span class="op">=</span> <span class="st">"Ozone"</span>, yVar <span class="op">=</span> <span class="st">"Temp"</span>, .self <span class="op">=</span> <span class="va">pip</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">collect_out</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.614] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.615] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.618] Step 2/4 fit</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.623] Step 3/4 residual_shapiro_p_value</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.627] Step 4/4 plot</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.635] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.636] Done.</span></span>
<span><span class="co"># $residual_shapiro_p_value</span></span>
<span><span class="co"># [1] 0.00022598</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $plot</span></span></code></pre></div>
<p><img src="v06-self-modify-pipeline_files/figure-html/unnamed-chunk-6-1.png" alt="residual-plot" width="700"></p>
<p>This simple “trick” opens up a wide range of possibilities for
pipeline modifications at runtime. As we will show in the next section,
this is not limited to changing parameters but can also be used to
modify the pipeline structure itself.</p>
</div>
<div class="section level3">
<h3 id="changing-the-pipeline-structure-at-runtime">Changing the pipeline structure at runtime<a class="anchor" aria-label="anchor" href="#changing-the-pipeline-structure-at-runtime"></a>
</h3>
<p>Subsequently, the pipeline steps will be comprised only of very basic
functions in order to keep the examples simple. The focus here is on the
pipeline structure and how it can be modified at runtime.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span><span class="st">"my-pipeline"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f1"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f2"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f3"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>This pipeline just adds 1, 2, and 3 to the input data,
respectively.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.895] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.896] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.899] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.902] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.904] Step 4/4 f3</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.905] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:32.906] Done.</span></span>
<span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data              1   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data      2   FALSE     f1   Done</span></span>
<span><span class="co"># 3:     f2      f1      4   FALSE     f2   Done</span></span>
<span><span class="co"># 4:     f3      f2      7   FALSE     f3   Done</span></span></code></pre></div>
<p>The <code>out</code> column in the table shows the output of each
step. Now let’s modify the last step of the pipeline such that if the
input is greater than 10, the pipeline will replace the last step with a
new step that now instead of <code>f2</code> references <code>f1</code>
and subtracts 3 from the input.</p>
<div class="section level4">
<h4 id="modify-a-step">Modify a step<a class="anchor" aria-label="anchor" href="#modify-a-step"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span><span class="st">"my-pipeline"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f1"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f2"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span>, <span class="va">.self</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="op">{</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">replace_step</span><span class="op">(</span></span>
<span>                    <span class="st">"f3"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">-</span> <span class="fl">3</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f3"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>If we run the pipeline as before, nothing will change.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.self <span class="op">=</span> <span class="va">pip</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.026] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.027] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.029] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.032] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.034] Step 4/4 f3</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.035] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.035] Done.</span></span>
<span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data              1   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data      2   FALSE     f1   Done</span></span>
<span><span class="co"># 3:     f2      f1      4   FALSE     f2   Done</span></span>
<span><span class="co"># 4:     f3      f2      7   FALSE     f3   Done</span></span></code></pre></div>
<p>Now let’s try it with an input of 10.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.094] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.095] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.097] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.100] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.105] Step 4/4 f3</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.106] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.107] Done.</span></span>
<span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data             10   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data     11   FALSE     f1   Done</span></span>
<span><span class="co"># 3:     f2      f1     13   FALSE     f2   Done</span></span>
<span><span class="co"># 4:     f3      f1      8   FALSE     f3   Done</span></span></code></pre></div>
<p>We see that both the output of the pipeline and the dependencies of
the last step have changed.</p>
</div>
<div class="section level4">
<h4 id="insert-and-remove-steps">Insert and remove steps<a class="anchor" aria-label="anchor" href="#insert-and-remove-steps"></a>
</h4>
<p>For our last example, instead of just replacing, we will go a bit
further to insert and remove steps. The pipeline definition is as
follows:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span></span>
<span>        <span class="st">"my-pipeline"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f1"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f2"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span>, <span class="va">.self</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">insert_after</span><span class="op">(</span></span>
<span>                    afterStep <span class="op">=</span> <span class="st">"f1"</span>,</span>
<span>                    step <span class="op">=</span> <span class="st">"f2a"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">+</span> <span class="fl">21</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">insert_after</span><span class="op">(</span></span>
<span>                    afterStep <span class="op">=</span> <span class="st">"f2a"</span>,</span>
<span>                    step <span class="op">=</span> <span class="st">"f2b"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2a</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">+</span> <span class="fl">22</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">replace_step</span><span class="op">(</span></span>
<span>                    <span class="st">"f3"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2b</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">+</span> <span class="fl">30</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">remove_step</span><span class="op">(</span><span class="st">"f2"</span><span class="op">)</span></span>
<span>                <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f3"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>Basically, if the input is greater than 10, we will insert two new
steps after <code>f1</code>, remove <code>f2</code>, and replace
<code>f3</code> with a new step that adds 30 to the input.</p>
<p>Also note that we return the pipeline object in this case. This is
important, because the pipeline’s <code>run</code> function has an
argument <code>recursive</code>, which by default is set to
<code>TRUE</code> and means that if a step returns a pipeline, the run
of the current pipeline is aborted and the returned pipeline is
re-run.</p>
<p>Let’s see the pipeline structure before running it.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data         [NULL]   FALSE   data    New</span></span>
<span><span class="co"># 2:     f1    data [NULL]   FALSE     f1    New</span></span>
<span><span class="co"># 3:     f2      f1 [NULL]   FALSE     f2    New</span></span>
<span><span class="co"># 4:     f3      f2 [NULL]   FALSE     f3    New</span></span></code></pre></div>
<p>And now let’s run it with an input of 10.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.self <span class="op">=</span> <span class="va">pip</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.279] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.280] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.283] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.285] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.298] Abort pipeline execution and restart on new.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.298] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.299] Step 1/5 data - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.300] Step 2/5 f1 - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.301] Step 3/5 f2a</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.306] Step 4/5 f2b</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.308] Step 5/5 f3</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.309] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-02 20:51:33.310] Done.</span></span></code></pre></div>
<p>The log output shows the abort and re-run of the pipeline. Let’s see
the final structure and step outputs.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data             10   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data     11   FALSE     f1   Done</span></span>
<span><span class="co"># 3:    f2a      f1     32   FALSE    f2a   Done</span></span>
<span><span class="co"># 4:    f2b     f2a     54   FALSE    f2b   Done</span></span>
<span><span class="co"># 5:     f3     f2b     84   FALSE     f3   Done</span></span></code></pre></div>
<p>The final structure is as expected with the new steps inserted and
the old step removed. As mentioned before, this is just a simple example
to show the possibilities. I leave it to the user to come up with more
sensible and complex use cases.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://rpahl.github.io/r-some-blog/about.html" class="external-link">Roman Pahl</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
