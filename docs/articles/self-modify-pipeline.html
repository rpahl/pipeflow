<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced: How pipelines can modify themselves at runtime • pipeflow</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced: How pipelines can modify themselves at runtime">
<meta property="og:description" content="Shows how you can setup pipelines to modify themselves at runtime, which, for example, allows for changing pipeline parameters based on intermediate results or even dynamically modify the pipeline's own structure during a pipeline run.
">
<meta property="og:image" content="https://github.com/rpahl/pipeflow/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pipeflow</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/get-started.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a></a>
    </li>
    <li>
      <a href="../articles/index.html">Overview</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Get started</li>
    <li>
      <a href="../articles/get-started.html">Get started with pipeflow</a>
    </li>
    <li>
      <a href="../articles/modify-pipeline.html">Modifying existing pipelines</a>
    </li>
    <li>
      <a href="../articles/combine-pipelines.html">Combining pipelines</a>
    </li>
    <li>
      <a href="../articles/collect-output.html">Collecting pipeline output</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/split-and-combine.html">How to use pipelines with split data sets</a>
    </li>
    <li>
      <a href="../articles/self-modify-pipeline.html">How pipelines can modify themselves at runtime</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    My packages

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://rpahl.github.io/container/" class="external-link">container</a>
    </li>
    <li>
      <a href="https://rpahl.github.io/GroupSeq/" class="external-link">GroupSeq</a>
    </li>
    <li>
      <a href="https://rpahl.github.io/pipeflow/" class="external-link">pipeflow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rpahl/pipeflow/">
    <span class="fab fa-github"></span>

  </a>
</li>
<li>
  <a href="https://stackoverflow.com/users/8120617/rpahl" class="external-link">
    <span class="fab fa-stack-overflow"></span>

  </a>
</li>
<li>
  <a href="https://bsky.app/profile/rpahl.bsky.social" class="external-link">
    <span class="fab fa-bluesky"></span>

  </a>
</li>
<li>
  <a href="https://rpahl.github.io/r-some-blog/" class="external-link">
    <span class="fas fa-blog"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Advanced: How pipelines can modify themselves at
runtime</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rpahl/pipeflow/blob/HEAD/vignettes/self-modify-pipeline.Rmd"><code>vignettes/self-modify-pipeline.Rmd</code></a></small>
      <div class="hidden name"><code>self-modify-pipeline.Rmd</code></div>

    </div>

    
    
<p>While the <code>pipeflow</code> package mostly aims to be an easy and
intuitive framework, it does provide some very advanced features and
interfaces that allow for a very flexible manipulation of the pipeline
objects. In this vignette we will introduce some of these features using
simple examples in order to give you an idea of what is possible.</p>
<div class="section level3">
<h3 id="changing-pipeline-parameters-at-runtime">Changing pipeline parameters at runtime<a class="anchor" aria-label="anchor" href="#changing-pipeline-parameters-at-runtime"></a>
</h3>
<p>Let’s first define a pipeline, which fits a linear model, checks it’s
residuals for normality using the Shapiro-Wilk test, and plots the
residuals.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpahl.github.io/pipeflow/" class="external-link">pipeflow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span><span class="st">"my-pipeline"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"fit"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">data</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span>, <span class="va">xVar</span> <span class="op">=</span> <span class="st">"x"</span>, <span class="va">yVar</span> <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">yVar</span>, <span class="st">"~"</span>, <span class="va">xVar</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"residual_shapiro_p_value"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">fit</span> <span class="op">=</span> <span class="op">~</span><span class="va">fit</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>            <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/shapiro.test.html" class="external-link">shapiro.test</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span>            <span class="va">p</span></span>
<span>        <span class="op">}</span>,</span>
<span>        keepOut <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"plot"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">fit</span> <span class="op">=</span> <span class="op">~</span><span class="va">fit</span>, <span class="va">pointColor</span> <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>                fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,</span>
<span>                residuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">fitted</span>, y <span class="op">=</span> <span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">21</span>, color <span class="op">=</span> <span class="va">pointColor</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        keepOut <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>So our pipeline looks like this</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span></span>
<span><span class="co">#                        step depends    out keepOut                    group  state</span></span>
<span><span class="co">#                      &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt;                   &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:                     data         [NULL]   FALSE                     data    New</span></span>
<span><span class="co"># 2:                      fit    data [NULL]   FALSE                      fit    New</span></span>
<span><span class="co"># 3: residual_shapiro_p_value     fit [NULL]    TRUE residual_shapiro_p_value    New</span></span>
<span><span class="co"># 4:                     plot     fit [NULL]    TRUE                     plot    New</span></span></code></pre></div>
<p>and we can run it like this</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xVar <span class="op">=</span> <span class="st">"Ozone"</span>, yVar <span class="op">=</span> <span class="st">"Temp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">collect_out</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:02.986] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.016] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.030] Step 2/4 fit</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.048] Step 3/4 residual_shapiro_p_value</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.050] Step 4/4 plot</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.065] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.066] Done.</span></span>
<span><span class="co"># $residual_shapiro_p_value</span></span>
<span><span class="co"># [1] 0.00022598</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $plot</span></span></code></pre></div>
<p><img src="self-modify-pipeline_files/figure-html/unnamed-chunk-3-1.png" alt="residual-plot" width="700"></p>
<p>Now let’s imagine, we want to change the color of the points in the
plot depending on the Shapiro-Wilk test result. The obvious way to do
this would be to change the <code>plot</code> step by passing the test
result to the <code>plot</code> step function and change the color
there.</p>
<p>However, here we are interested in another way that would keep the
<code>plot</code> function unchanged. For example, we could run the
pipeline a second time as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">pip</span><span class="op">$</span><span class="fu">get_out</span><span class="op">(</span><span class="st">"residual_shapiro_p_value"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointColor <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">pip</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">collect_out</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.468] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.469] Step 1/4 data - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.470] Step 2/4 fit - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.471] Step 3/4 residual_shapiro_p_value - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.472] Step 4/4 plot</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.486] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.487] Done.</span></span>
<span><span class="co"># $residual_shapiro_p_value</span></span>
<span><span class="co"># [1] 0.00022598</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $plot</span></span></code></pre></div>
<p><img src="self-modify-pipeline_files/figure-html/unnamed-chunk-4-1.png" alt="residual-plot" width="700"></p>
<p>As was mentioned in another vignette, this solution is not ideal, as
it requires to run additional code outside the pipeline framework. To
solve this issue, we therefore basically have to set the parameter from
within the pipeline during execution. That is, we have to make the
pipeline aware of itself, which can be done by passing the pipeline
object as a parameter.</p>
<p>Let’s update the <code>residual_shapiro_p_value</code> step in the
above example.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">replace_step</span><span class="op">(</span></span>
<span>    <span class="st">"residual_shapiro_p_value"</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span></span>
<span>        <span class="va">fit</span> <span class="op">=</span> <span class="op">~</span><span class="va">fit</span>,</span>
<span>        <span class="va">.self</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>        <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/shapiro.test.html" class="external-link">shapiro.test</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">p</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">.self</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointColor <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="va">p</span></span>
<span>    <span class="op">}</span>,</span>
<span>    keepOut <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we just have to make sure to set the <code>.self</code>
parameter.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xVar <span class="op">=</span> <span class="st">"Ozone"</span>, yVar <span class="op">=</span> <span class="st">"Temp"</span>, .self <span class="op">=</span> <span class="va">pip</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">collect_out</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.788] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.789] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.791] Step 2/4 fit</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.796] Step 3/4 residual_shapiro_p_value</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.800] Step 4/4 plot</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.807] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:03.808] Done.</span></span>
<span><span class="co"># $residual_shapiro_p_value</span></span>
<span><span class="co"># [1] 0.00022598</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $plot</span></span></code></pre></div>
<p><img src="self-modify-pipeline_files/figure-html/unnamed-chunk-6-1.png" alt="residual-plot" width="700"></p>
<p>This simple “trick” opens up a wide range of possibilities for
pipeline modifications at runtime. As we will show in the next section,
this is not limited to changing parameters but can also be used to
modify the pipeline structure itself.</p>
</div>
<div class="section level3">
<h3 id="changing-the-pipeline-structure-at-runtime">Changing the pipeline structure at runtime<a class="anchor" aria-label="anchor" href="#changing-the-pipeline-structure-at-runtime"></a>
</h3>
<p>Subsequently, the pipeline steps will be comprised only of very basic
functions in order to keep the examples simple. The focus here is on the
pipeline structure and how it can be modified at runtime.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span><span class="st">"my-pipeline"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f1"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f2"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f3"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>This pipeline just adds 1, 2, and 3 to the input data,
respectively.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.064] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.065] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.067] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.070] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.072] Step 4/4 f3</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.073] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.074] Done.</span></span>
<span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data              1   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data      2   FALSE     f1   Done</span></span>
<span><span class="co"># 3:     f2      f1      4   FALSE     f2   Done</span></span>
<span><span class="co"># 4:     f3      f2      7   FALSE     f3   Done</span></span></code></pre></div>
<p>The <code>out</code> column in the table shows the output of each
step. Now let’s modify the last step of the pipeline such that if the
input is greater than 10, the pipeline will replace the last step with a
new step that now instead of <code>f2</code> references <code>f1</code>
and subtracts 3 from the input.</p>
<div class="section level4">
<h4 id="modify-a-step">Modify a step<a class="anchor" aria-label="anchor" href="#modify-a-step"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span><span class="st">"my-pipeline"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f1"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f2"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span>, <span class="va">.self</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="op">{</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">replace_step</span><span class="op">(</span></span>
<span>                    <span class="st">"f3"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">-</span> <span class="fl">3</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f3"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>If we run the pipeline as before, nothing will change.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.self <span class="op">=</span> <span class="va">pip</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.194] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.195] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.197] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.199] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.201] Step 4/4 f3</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.203] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.203] Done.</span></span>
<span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data              1   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data      2   FALSE     f1   Done</span></span>
<span><span class="co"># 3:     f2      f1      4   FALSE     f2   Done</span></span>
<span><span class="co"># 4:     f3      f2      7   FALSE     f3   Done</span></span></code></pre></div>
<p>Now let’s try it with an input of 10.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.262] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.264] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.266] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.269] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.275] Step 4/4 f3</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.276] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.276] Done.</span></span>
<span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data             10   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data     11   FALSE     f1   Done</span></span>
<span><span class="co"># 3:     f2      f1     13   FALSE     f2   Done</span></span>
<span><span class="co"># 4:     f3      f1      8   FALSE     f3   Done</span></span></code></pre></div>
<p>We see that both the output of the pipeline and the dependencies of
the last step have changed.</p>
</div>
<div class="section level4">
<h4 id="insert-and-remove-steps">Insert and remove steps<a class="anchor" aria-label="anchor" href="#insert-and-remove-steps"></a>
</h4>
<p>For our last example, instead of just replacing, we will go a bit
further to insert and remove steps. The pipeline definition is as
follows:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pipelineAliases.html">pipe_new</a></span><span class="op">(</span></span>
<span>        <span class="st">"my-pipeline"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f1"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f2"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span>, <span class="va">.self</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>        <span class="op">{</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">insert_after</span><span class="op">(</span></span>
<span>                    afterStep <span class="op">=</span> <span class="st">"f1"</span>,</span>
<span>                    step <span class="op">=</span> <span class="st">"f2a"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f1</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">+</span> <span class="fl">21</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">insert_after</span><span class="op">(</span></span>
<span>                    afterStep <span class="op">=</span> <span class="st">"f2a"</span>,</span>
<span>                    step <span class="op">=</span> <span class="st">"f2b"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2a</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">+</span> <span class="fl">22</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">replace_step</span><span class="op">(</span></span>
<span>                    <span class="st">"f3"</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2b</span><span class="op">)</span> <span class="op">{</span></span>
<span>                        <span class="va">x</span> <span class="op">+</span> <span class="fl">30</span></span>
<span>                    <span class="op">}</span></span>
<span>                <span class="op">)</span></span>
<span>                <span class="va">.self</span><span class="op">$</span><span class="fu">remove_step</span><span class="op">(</span><span class="st">"f2"</span><span class="op">)</span></span>
<span>                <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">.self</span><span class="op">)</span></span>
<span>            <span class="op">}</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/pipelineAliases.html">pipe_add</a></span><span class="op">(</span></span>
<span>        <span class="st">"f3"</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="op">~</span><span class="va">f2</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>Basically, if the input is greater than 10, we will insert two new
steps after <code>f1</code>, remove <code>f2</code>, and replace
<code>f3</code> with a new step that adds 30 to the input.</p>
<p>Also note that we return the pipeline object in this case. This is
important, because the pipeline’s <code>run</code> function has an
argument <code>recursive</code>, which by default is set to
<code>TRUE</code> and means that if a step returns a pipeline, the run
of the current pipeline is aborted and the returned pipeline is
re-run.</p>
<p>Let’s see the pipeline structure before running it.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data         [NULL]   FALSE   data    New</span></span>
<span><span class="co"># 2:     f1    data [NULL]   FALSE     f1    New</span></span>
<span><span class="co"># 3:     f2      f1 [NULL]   FALSE     f2    New</span></span>
<span><span class="co"># 4:     f3      f2 [NULL]   FALSE     f3    New</span></span></code></pre></div>
<p>And now let’s run it with an input of 10.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span><span class="op">$</span><span class="fu">set_params</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.self <span class="op">=</span> <span class="va">pip</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pip</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.453] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.454] Step 1/4 data</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.457] Step 2/4 f1</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.460] Step 3/4 f2</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.475] Abort pipeline execution and restart on new.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.475] Start run of 'my-pipeline' pipeline:</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.476] Step 1/5 data - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.477] Step 2/5 f1 - skip 'done' step</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.478] Step 3/5 f2a</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.484] Step 4/5 f2b</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.487] Step 5/5 f3</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.489] Finished execution of steps.</span></span>
<span><span class="co"># INFO  [2024-12-01 17:14:04.489] Done.</span></span></code></pre></div>
<p>The log output shows the abort and re-run of the pipeline. Let’s see
the final structure and step outputs.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pip</span></span>
<span><span class="co">#      step depends    out keepOut  group  state</span></span>
<span><span class="co">#    &lt;char&gt;  &lt;list&gt; &lt;list&gt;  &lt;lgcl&gt; &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co"># 1:   data             10   FALSE   data   Done</span></span>
<span><span class="co"># 2:     f1    data     11   FALSE     f1   Done</span></span>
<span><span class="co"># 3:    f2a      f1     32   FALSE    f2a   Done</span></span>
<span><span class="co"># 4:    f2b     f2a     54   FALSE    f2b   Done</span></span>
<span><span class="co"># 5:     f3     f2b     84   FALSE     f3   Done</span></span></code></pre></div>
<p>The final structure is as expected with the new steps inserted and
the old step removed. As mentioned before, this is just a simple example
to show the possibilities. I leave it to the user to come up with more
sensible and complex use cases.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://rpahl.github.io/r-some-blog/about.html" class="external-link">Roman Pahl</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
